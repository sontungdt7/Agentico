# Salt miner server for Render.com
# Build context: Agentico repo root (single repo, no liquidity-launcher sibling)
# Clones liquidity-launcher during build

# Build address-miner
FROM rust:latest AS miner
WORKDIR /build
RUN apt-get update && apt-get install -y pkg-config libssl-dev && rm -rf /var/lib/apt/lists/*

COPY contracts/script/saltGenerator ./
# Update dependencies to latest compatible versions
RUN cargo update && cargo build --release

# Build salt-miner-server (Node.js)
FROM node:20-slim AS nodebuild
WORKDIR /build
COPY salt-miner-server/package*.json ./
COPY salt-miner-server/tsconfig.json ./
COPY salt-miner-server/src ./src
RUN npm ci && npm run build

# Final image: Node + Foundry (Node base to avoid Foundry image's non-root apt restrictions)
FROM node:20-bookworm-slim
WORKDIR /app

# Install Foundry + git for clone
RUN apt-get update && apt-get install -y curl git && \
    curl -L https://foundry.paradigm.xyz | bash && \
    /root/.foundry/bin/foundryup && \
    rm -rf /var/lib/apt/lists/*
ENV PATH="/root/.foundry/bin:${PATH}"

# Layout: contracts expect ../../liquidity-launcher (sibling of parent)
# So we need /app/agentico/contracts and /app/liquidity-launcher
# Clone with submodules (v4-periphery, v4-core, etc.) - use HTTPS for git@ submodules
RUN git config --global url."https://github.com/".insteadOf "git@github.com:" && \
    git clone --depth 1 --recurse-submodules --shallow-submodules \
    https://github.com/Uniswap/liquidity-launcher.git ./liquidity-launcher && \
    mkdir -p agentico

# Copy contracts to agentico/ so ../../ from contracts = /app
COPY contracts ./agentico/contracts

# Install forge-std (required by GetInitCodeHashSepolia)
RUN git clone --depth 1 https://github.com/foundry-rs/forge-std.git /app/agentico/contracts/lib/forge-std

# Copy built miner
COPY --from=miner /build/target/release/address-miner ./agentico/contracts/script/saltGenerator/target/release/address-miner

# Copy built salt-miner-server (dist + node_modules for runtime)
COPY --from=nodebuild /build/dist ./salt-miner-server/dist
COPY --from=nodebuild /build/node_modules ./salt-miner-server/node_modules
COPY salt-miner-server/package*.json ./salt-miner-server/

ENV CONTRACTS_DIR=/app/agentico/contracts
ENV PORT=3040

EXPOSE 3040

CMD ["node", "salt-miner-server/dist/index.js"]
